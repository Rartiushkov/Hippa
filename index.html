<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HIPAA Sign</title>

  <!-- HelloSign Embedded -->
  <script src="https://cdn.hellosign.com/public/js/embedded/v2.11.1/embedded.development.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 16px; }
    .box { max-width: 720px; margin: 0 auto; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin: 12px 0; }
    .muted { color: #666; }
    pre { white-space: pre-wrap; word-break: break-word; margin: 0; }
    .ok { color: #0a7; }
    .bad { color: #c22; }
  </style>
</head>
<body>
  <div class="box">
    <h2>HIPAA Sign</h2>
    <div class="card muted" id="top">Loading secure signing session…</div>

    <div class="card"><b>SID:</b> <span id="sid">—</span></div>

    <div class="card">
      <div><b>Status:</b> <span id="status">—</span></div>
      <div class="muted" style="margin-top:6px;">Open in Safari if you came from WhatsApp.</div>
    </div>

    <div class="card">
      <div><b>API response:</b></div>
      <pre id="api">—</pre>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const setTop = (msg, cls) => { $('top').textContent = msg; $('top').className = 'card ' + (cls || 'muted'); };
    const setStatus = (msg, cls) => { $('status').textContent = msg; $('status').className = (cls || ''); console.log('[SIGN]', msg); };
    const setApi = (obj) => { $('api').textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2); };

    function qp(name) {
      const u = new URL(window.location.href);
      return u.searchParams.get(name);
    }

    async function main() {
      const sid = qp('sid');
      $('sid').textContent = sid || '—';
      if (!sid) {
        setTop('Missing sid in URL', 'bad');
        setStatus('Missing sid', 'bad');
        return;
      }

      // ✅ твой API Gateway base (без /api/... в конце)
      const API_BASE = 'https://6cxl9xwo00.execute-api.eu-north-1.amazonaws.com';
      const url = `${API_BASE}/api/sign_url?sid=${encodeURIComponent(sid)}`;

      // покажем, в каком браузере открыли
      const ua = navigator.userAgent || '';
      console.log('[UA]', ua);

      setTop('Requesting sign_url…');
      setStatus('Calling API…');

      let data;
      try {
        const resp = await fetch(url, { method: 'GET', headers: { 'accept': 'application/json' } });
        const txt = await resp.text();
        try { data = JSON.parse(txt); } catch { data = { ok: false, raw: txt, http_status: resp.status }; }
        data.http_status = resp.status;
      } catch (e) {
        setTop('Network error calling API', 'bad');
        setStatus('Network error (see console)', 'bad');
        console.error(e);
        return;
      }

      setApi(data);

      if (!data || data.ok !== true) {
        setTop('API did not return ok=true', 'bad');
        setStatus('API error: ' + (data && data.error ? data.error : 'unknown'), 'bad');
        return;
      }

      if (!data.sign_url || !data.client_id) {
        setTop('API did not return sign_url/client_id.', 'bad');
        setStatus('Missing sign_url or client_id', 'bad');
        return;
      }

      setTop('Opening embedded signer…', 'ok');
      setStatus('Embedded opening…');

      const client = new HelloSign({ clientId: data.client_id });

      client.open(data.sign_url, {
        // ✅ key fixes for iPhone UI
        skipDomainVerification: true,
        allowCancel: true,
        debug: true,

        // ✅ force full screen and make sure it attaches to body
        container: document.body,
        useFullScreen: true
      });

      client.on('open', () => setStatus('Embedded opened.', 'ok'));
      client.on('sign', () => setStatus('Signed ✅ You can close this page.', 'ok'));
      client.on('cancel', () => setStatus('Signing cancelled.'));
      client.on('error', (e) => {
        setTop('Embed error. Check console.', 'bad');
        setStatus('Embed error', 'bad');
        console.error('HelloSign error:', e);
      });
    }

    main().catch((e) => {
      setTop('Fatal error. Check console.', 'bad');
      setStatus('Fatal error', 'bad');
      console.error(e);
    });
  </script>
</body>
</html>
