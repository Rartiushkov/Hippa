<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HIPAA Sign</title>
  <style>
    body { font-family: system-ui, Arial; margin: 16px; }
    .box { padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 12px; }
    pre { white-space: pre-wrap; word-break: break-word; }
    #sign-container { width: 100%; height: 92vh; border: 1px solid #ddd; border-radius: 10px; overflow: hidden; }
  </style>
</head>
<body>
  <h2>HIPAA Sign</h2>

  <div class="box" id="status">Loading…</div>
  <div class="box"><b>SID:</b> <span id="sid"></span></div>
  <div class="box"><b>API response:</b><pre id="api"></pre></div>

  <div id="sign-container"></div>

  <!-- Dropbox Sign Embedded -->
  <script src="https://cdn.hellosign.com/public/js/embedded/v2.11.1/embedded.development.js"></script>

  <script>
    const elStatus = document.getElementById('status');
    const elSid = document.getElementById('sid');
    const elApi = document.getElementById('api');

    function setStatus(msg) { elStatus.textContent = msg; }

    function getSid() {
      const u = new URL(window.location.href);
      return (u.searchParams.get('sid') || '').trim();
    }

    async function main() {
      const sid = getSid();
      elSid.textContent = sid || '(missing)';
      if (!sid) {
        setStatus('Missing sid in URL. Example: /sign?sid=...');
        return;
      }

      setStatus('Fetching sign_url…');
      const apiUrl = `https://6cxl9xwo00.execute-api.eu-north-1.amazonaws.com/api/sign_url?sid=${encodeURIComponent(sid)}`;

      let data;
      try {
        const res = await fetch(apiUrl, { method: 'GET' });
        data = await res.json();
      } catch (e) {
        elApi.textContent = String(e);
        setStatus('Failed to call API (network/CORS).');
        return;
      }

      elApi.textContent = JSON.stringify(data, null, 2);

      if (!data || !data.ok || !data.sign_url || !data.client_id) {
        setStatus('API did not return sign_url/client_id.');
        return;
      }

      setStatus('Opening embedded signing…');

      const client = new window.HelloSign();
      client.on('open', () => setStatus('Embedded opened.'));
      client.on('sign', () => setStatus('Signed ✅ (you can close this tab).'));
      client.on('close', () => setStatus('Closed.'));
      client.on('error', (err) => {
        setStatus('Embedded error: ' + (err && (err.message || err.toString())));
      });

      // IMPORTANT: allow skipping domain verification for test_mode only
      client.open(data.sign_url, {
        clientId: data.client_id,
        container: document.getElementById('sign-container'),
        skipDomainVerification: (data.test_mode === "1")
      });
    }

    main();
  </script>
</body>
</html>
