<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HIPAA Sign</title>
  <script src="https://cdn.hellosign.com/public/js/embedded/v2.11.1/embedded.development.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .box { max-width: 720px; margin: 0 auto; }
    .muted { color: #666; }
    #status { margin-top: 10px; }
  </style>
</head>
<body>
  <div class="box">
    <h2>Signing page</h2>
    <div class="muted">Loading secure signing session…</div>
    <div id="status"></div>
  </div>

  <script>
    const STATUS = document.getElementById('status');

    function setStatus(msg) {
      STATUS.textContent = msg;
      console.log('[SIGN]', msg);
    }

    function qp(name) {
      const u = new URL(window.location.href);
      return u.searchParams.get(name);
    }

    async function main() {
      const sid = qp('sid');
      if (!sid) {
        setStatus('Missing sid in URL');
        return;
      }

      // ВАЖНО: поставь сюда твой API Gateway домен
      const API_BASE = 'https://YOUR_API_GATEWAY_DOMAIN'; // <= замени
      const url = `${API_BASE}/api/sign_url?sid=${encodeURIComponent(sid)}`;

      setStatus('Requesting sign_url…');

      const resp = await fetch(url, { method: 'GET' });
      const data = await resp.json();

      if (!data || !data.ok) {
        setStatus('API error: ' + (data && data.error ? data.error : 'unknown'));
        console.log('API response:', data);
        return;
      }

      if (!data.sign_url || !data.client_id) {
        setStatus('API response missing sign_url/client_id');
        console.log('API response:', data);
        return;
      }

      setStatus('Opening embedded signer…');

      const client = new HelloSign({
        clientId: data.client_id
      });

      client.open(data.sign_url, {
        skipDomainVerification: true,
        allowCancel: true,
        debug: true
      });

      client.on('sign', () => setStatus('Signed ✅ You can close this page.'));
      client.on('cancel', () => setStatus('Signing cancelled.'));
      client.on('error', (e) => {
        setStatus('Embed error. Check console.');
        console.error('HelloSign error:', e);
      });
    }

    main().catch((e) => {
      setStatus('Fatal error. Check console.');
      console.error(e);
    });
  </script>
</body>
</html>
