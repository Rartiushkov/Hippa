<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HIPAA Sign</title>
  <script src="https://cdn.hellosign.com/public/js/embedded/v2.1.0/embedded.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    .box { padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 12px; }
    #container { width: 100%; height: 85vh; border: 1px solid #eee; border-radius: 10px; overflow: hidden; }
    code { background: #f6f6f6; padding: 2px 6px; border-radius: 6px; }
    pre { background: #0b0b0b; color: #d9d9d9; padding: 10px; border-radius: 10px; overflow:auto; }
  </style>
</head>
<body>

  <h2>HIPAA Sign</h2>

  <div class="box">
    <div><b>SID:</b> <span id="sid">(loading)</span></div>
    <div><b>Status:</b> <span id="status">Init…</span></div>
  </div>

  <div class="box">
    <div><b>API response:</b></div>
    <pre id="api">(waiting)</pre>
  </div>

  <div id="container"></div>

<script>
  const API_BASE = "https://6cxl9xwo00.execute-api.eu-north-1.amazonaws.com";

  const sid = new URLSearchParams(window.location.search).get("sid");
  document.getElementById("sid").textContent = sid || "(missing)";

  if (!sid) {
    document.getElementById("status").textContent =
      "Missing sid in URL. Example: /?sid=...";
    document.getElementById("api").textContent =
      "Open this page with ?sid=<signature_id>";
  } else {
    document.getElementById("status").textContent = "Fetching sign_url…";

    fetch(`${API_BASE}/api/sign_url?sid=${encodeURIComponent(sid)}`)
      .then(r => r.json())
      .then(data => {
        document.getElementById("api").textContent = JSON.stringify(data, null, 2);

        const signUrl = data.sign_url || (data.embedded && data.embedded.sign_url);
        const clientId = data.client_id;

        if (!signUrl) {
          document.getElementById("status").textContent = "No sign_url in API response";
          return;
        }
        if (!clientId) {
          document.getElementById("status").textContent = "No client_id in API response";
          return;
        }

        document.getElementById("status").textContent = "Opening embedded signing…";

        const client = new HelloSign({ clientId });

        client.open(signUrl, {
          container: document.getElementById("container"),
          skipDomainVerification: true
        });

        client.on("error", (err) => {
          document.getElementById("status").textContent = "HelloSign error (see console)";
          console.error("HelloSign error:", err);
        });

        client.on("sign", () => {
          document.getElementById("status").textContent = "Signed ✅";
        });

        client.on("close", () => {
          // not always fired depending on embedded flow
          console.log("HelloSign closed");
        });

      })
      .catch(err => {
        document.getElementById("status").textContent = "Fetch failed (see console)";
        document.getElementById("api").textContent = String(err);
        console.error(err);
      });
  }
</script>

</body>
</html>
